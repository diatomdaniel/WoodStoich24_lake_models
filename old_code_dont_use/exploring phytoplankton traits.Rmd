---
title: "Exploring Edwards et al 2016 trait data"
author: "Daniel Gschwentner"
date: "2024-06-20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Overview

This document contains code to explore and summarize phytoplankton trait from [Edwards et al., 2016.](https://figshare.com/articles/dataset/Data_Paper_Data_Paper/3562857?file=5635515) These data will be used to parameterize lake ecosystem models of phytoplankton competition across TN and TP inflow gradients.

Phytoplankton traits of interest are as follows:

-   V\~max\~ for N and P (maximum uptake rate)

-   K\~sat\~ for N and P (half-saturation constants)

-   Q\~min\~ for N and P (minimum cell quota)

-   I\~0\~ for light (effectively the light half saturation constant)

    -   Note that light data is not available here but is presented in [Schwaderer et al., 2011](10.4319/lo.2011.56.2.0589). These data will need to be extracted/digitized.

-   Cell C volume for conversion of trait parameters

-   u\~max\~ maximum growth rate

    -   The u~maxes~ listed in this data set are for N- and P-limited conditions. Max growth rates can be pulled from [Edwards et al., 2011](10.4319/lo.2012.57.2.0554).

We're only looking for these parameters for diatoms, cyanobacteria and chlorophytes.

#### Units

The units for traits of interest are listed below:

-   C cell^1^ content = umol C cell^-1^

-   u~max~ for N, P limited growth =day^-1^

-   K~N,P~ for uptake = umol N or P L^-1^

-   V~max~ for N, P uptake = umol N or P cell^-1^ day^-1^

    -   Conversion is as follows: (1) multiple with molar weight to get ug N cell^-1^ day^-1^; (2) divide by C cell content in ug C cell^-1^; (3) divide by 1,000 to convert ug to mg for models.

-   Q~min~ and ~max~ for N, P = umol N or P cell^-1^

    -   Conversion is same as for V~max~.

### Loading data

```{r packages, echo = F, message=F, warning=F, results = "hide"}
library(tidyverse)
library(cowplot)
library(ggsci)
```

```{r data, echo = F, message=F, results="hide"}

all.traits <- read_csv("data4input/edwards phytoplankton traits compiled.csv")
light.umax <- read_csv("data4input/light and growth Schwaderer et al 2011.csv")
```

## Data exploration

```{r structure of data}
dim(all.traits)
colnames(all.traits)
head(all.traits)

```

#### Data structure notes

384 observations of 42 variables; variables of interest are as follows:

-   species, taxon, system

-   c_per_cell

-   k_nit, vmax_nit, qmin_nit, qmax_nit

-   k_p, vmax_p, qmin_p, qmax_p

-   mu_nit, mu_p

```{r marine vs freshwater nr of taxa and entries}
unique(all.traits$system)
all.traits$system <- ifelse(all.traits$system == "fresh", "freshwater", all.traits$system)
unique(all.traits$taxon)

table(all.traits$system)
table(all.traits$taxon)
table(all.traits$system, all.traits$taxon)
```

There are 211 entries for freshwater systems and 173 for marine. The majority of entries are for diatoms (n = 134), green algae (n = 120), and cyanobacteria (n = 47). Breaking down these data by system and taxon shows that there are more observations for green algae in freshwater systems (n\~fresh} = 101, n\~marine\~ = 19) and for cyanobacteria (n\~fresh\~ = 40, n\~marine\~ = 7) but not for diatoms (n\~fresh\~ = 57, n\~marine\~ = 77).

#### Subset data

Subset data to only include green algae, diatoms, cyanobacteria and select traits listed above. Will keep both marine and freshwater phytoplankton for now as [Edwards et al., 2011]() and [Litchmann et al., 2007]() review papers suggest that there is not that much difference between traits of freshwater and marine species, particularly once they have been normalized to cell volume.

```{r subset and filter}

selected.traits <- all.traits %>%
  filter(taxon %in% c("green", "diatom", "cyano")) %>%
  select(species, taxon, system, c_per_cell, k_nit, vmax_nit, qmin_nit, qmax_nit, 
         k_p, vmax_p, qmin_p, qmax_p, mu_nit, mu_p)


```

```{r check nr of non-detects}

# nr and percent of observations with data for each parameter
apply(selected.traits, 2, function(x) sum(!is.na(x)))
apply(selected.traits, 2, function(x) sum(!is.na(x))) * 100/nrow(selected.traits)

```

-   C per cell = 9 observations (3%)

-   K~nit~ = 66 (22%), Vmax~nit~ = 61 (20%), Qmin~nit~ = 48 (16%), Qmax~nit~ = 17 (6%), u~nit~ = 16 (5%)

-   K\~P) = 113 (38%), Vmax~P~ = 115 (38%), Qmin~P~ = 117 (39%), Qmax~P~ = 38 (13%), u~P~ = 33 (11%)

```{r check nr of observations per taxon in freshwater and marine}

selected.traits %>% 
  select(-species) %>%
  gather("trait", "trait.value", -system, -taxon) %>%
  group_by(system, taxon, trait) %>%
  mutate(not.na = !is.na(trait.value)) %>%
  summarise(nr.obs = sum(not.na)) %>%
  mutate(perc.obs = round(nr.obs * 100/nrow(selected.traits), 2)) %>%
  pivot_wider(id_cols = c(taxon, trait), 
              names_from = system, 
              values_from = nr.obs) %>%
  knitr::kable()

```

## Summary of phytoplankton traits

```{r figure of phytoplankton traits, warning=F, message=F, fig.width=15, fig.height=10, dpi = 400}

selected.traits %>%
  select(-species) %>%
  gather("trait", "trait.value", -system, -taxon) %>%
  ggplot(aes(trait.value, fill = taxon), alpha = 0.3) + 
  geom_density() + 
  ggh4x::facet_grid2(system~trait, scales = "free", independent = "all") + 
  labs(x = "Trait value", y = "Density", fill = NULL) + 
  theme(legend.position = "bottom")

```

### Differences in phytoplankton traits by system

```{r differences in traits by system}

selected.traits %>%
  select(-species) %>%
  gather("trait", "trait.value", -system, -taxon) %>%
  ggplot(aes(system, log(trait.value))) + 
  geom_boxplot() + 
  facet_wrap(trait~.,scales = "free")

```

### Create summary table of phytoplankton traits

```{r mean median sd table of phytoplankton traits}

selected.traits %>%
  select(-species) %>%
  gather("trait", "trait.value", -system, -taxon) %>%
  group_by(system, taxon, trait) %>%
  summarise(min = min(trait.value, na.rm = T),
            mean = mean(trait.value, na.rm = T),
            median = median(trait.value, na.rm = T),
            max = max(trait.value, na.rm = T),
            sd = sd(trait.value, na.rm = T),
            n = n()) %>%
  knitr::kable()

```

### Overview of traits by freshwater taxa

```{r freshwater taxa traits}

selected.traits %>%
  select(-species) %>%
  gather("trait", "trait.value", -system, -taxon) %>%
  filter(system == "marine") %>%
  ggplot(aes(taxon, trait.value)) + 
  geom_violin() + 
  facet_wrap(trait~.,scales = "free")

```

## Taxon-specific trait values

Here I summarize the taxon-specific trait values and provide average values to parameterize models.

```{r custom summary function}

cust.sum <- function(x){
  x <- x[!is.na(x)]
  x.mean = mean(x); x.median = median(x); x.min = min(x); x.max = max(x); x.sd = sd(x); x.n = length(x);
  x <- list(
    mean = x.mean,
    median = x.median,
    min = x.min,
    max = x.max,
    sd = x.sd,
    var = x.mean/x.sd * 100,
    n = x.n
  )
  return(x)
}

# conversion function
mole2mass <- function(x, y){
  return(x * y)
}


# quick reminder of traits
colnames(selected.traits)

```

### Diatoms

```{r diatom traits, warning = F, message=F}

diatoms <- selected.traits[selected.traits$taxon == "diatom" & selected.traits$system == "freshwater",]
#summary(diatoms)
(diatoms.traits <- diatoms %>%
  select(-species, -taxon, -system) %>%
  gather("Trait", "trait.value") %>%
  drop_na() %>%
  group_by(Trait) %>%
  summarise(
    Mean = mean(trait.value, na.rm = T),
    Median = median(trait.value, na.rm = T),
    Min = min(trait.value, na.rm = T), 
    Max = max(trait.value, na.rm = T),
    sd = sd(trait.value, na.rm = T),
    std.err = sd(trait.value, na.rm = T)/sqrt(n()),
    n = n()
  )) %>%
  knitr::kable()

```

These values are all annoyingly small, so they are difficult to read; there is no cell C content for freshwater diatoms, the median + range of marine diatoms is 0.0000012 (0.00000038 to 0.000417) umol C cell^-1^. Conversion to mass units helps with legibility...

#### Diatom unit conversions

```{r diatoms unit conversions}

# DIY conversions
diatoms.traits.mass.units <- diatoms %>%
   mutate(cell_C_mg = c_per_cell * 12.011/1000,
          K_P_mgL = k_p * 30.974/1000,
          K_N_mgL = k_nit*14.007/1000)
# for Vmax, Qmax use the median C content for conversion
### for diatoms, this will be median of marine C content!
median.C.marine.diatoms <- selected.traits %>% filter(taxon == "diatom") %>%
  mutate(cell_C_mg = c_per_cell * 12.011/1000)
median.C.marine.diatoms <- median(median.C.marine.diatoms$cell_C_mg, na.rm = T)
#median.C.marine.diatoms
# conversions pt 2
diatoms.traits.mass.units <- diatoms.traits.mass.units %>%
  mutate(Qmax_mg_N_mg_C = qmax_nit * 14.007/median.C.marine.diatoms/1000,
         Qmax_mg_P_mg_C = qmax_p * 30.974/median.C.marine.diatoms/1000,
         Qmin_mg_N_mg_C = qmin_nit * 14.007/median.C.marine.diatoms/1000,
         Qmin_mg_P_mg_C = qmin_p * 30.974/median.C.marine.diatoms/1000,
         Vmax_mg_N_mg_C = vmax_nit* 14.007/median.C.marine.diatoms/1000,
         Vmax_mg_P_mg_C = vmax_p * 30.974/median.C.marine.diatoms/1000,
         umax_N = mu_nit,
         umax_P = mu_p)
# save for plotting below
diatoms.traits.mass.units2 <- diatoms.traits.mass.units
# add marine diatoms cell content
marine.diatoms.cpercell <-  selected.traits[selected.traits$taxon == "diatom" & selected.traits$system == "marine",] %>% select(species, taxon, system, c_per_cell)
# merge together
diatoms.traits.mass.units2 <- bind_rows(diatoms.traits.mass.units2, marine.diatoms.cpercell)

# summary
(diatoms.traits.mass <- diatoms.traits.mass.units %>%
  select(K_P_mgL, K_N_mgL, Qmax_mg_N_mg_C, Qmax_mg_P_mg_C, Qmin_mg_N_mg_C, Qmin_mg_P_mg_C, Vmax_mg_N_mg_C, Vmax_mg_P_mg_C, umax_N, umax_P) %>%
  gather("Trait", "trait.value") %>%
  drop_na() %>%
  group_by(Trait) %>%
  summarise(
    Mean = mean(trait.value, na.rm = T),
    Median = median(trait.value, na.rm = T),
    Min = min(trait.value, na.rm = T), 
    Max = max(trait.value, na.rm = T),
    sd = sd(trait.value, na.rm = T),
    std.err = sd(trait.value, na.rm = T)/sqrt(n()),
    q25 = quantile(trait.value, 0.25, na.rm = T),
    q75 = quantile(trait.value, 0.75, na.rm = T),
    n = n()
  ) %>% mutate(taxon = "diatoms")) %>%
  knitr::kable()
```

There are two really large values for V~max~ for N and P which result in large medians and standard deviations. This might be something to revisit if diatoms end up being *too competitive* compared to cyanobacteria and green algae. Overall, diatoms appear to be more competitive for N than for P.

### Green algae

```{r green traits}

greens <- selected.traits[selected.traits$taxon == "green" & selected.traits$system == "freshwater",]
#summary(greens)
(greens.traits <- greens %>%
  select(-species, -taxon, -system) %>%
  gather("Trait", "trait.value") %>%
  drop_na() %>%
  group_by(Trait) %>%
  summarise(
    Mean = mean(trait.value, na.rm = T),
    Median = median(trait.value, na.rm = T),
    Min = min(trait.value, na.rm = T), 
    Max = max(trait.value, na.rm = T),
    sd = sd(trait.value, na.rm = T),
    std.err = sd(trait.value, na.rm = T)/sqrt(n()),
    n = n()
  )) %>%
  knitr::kable()
```

#### Green algae unit conversions

```{r green algae unit conversions}

# DIY conversions
greens.traits.mass.units <- greens %>%
   mutate(cell_C_mg = c_per_cell * 12.011/1000,
          K_P_mgL = k_p * 30.974/1000,
          K_N_mgL = k_nit*14.007/1000)
# for Vmax, Qmax use the median C content for conversion
### for diatoms, this will be median of marine C content!
median.C.greens <- median(greens.traits.mass.units$cell_C_mg, na.rm = T)
median.C.greens
# conversions pt 2
greens.traits.mass.units <- greens.traits.mass.units %>%
  mutate(Qmax_mg_N_mg_C = qmax_nit * 14.007/median.C.greens/1000,
         Qmax_mg_P_mg_C = qmax_p * 30.974/median.C.greens/1000,
         Qmin_mg_N_mg_C = qmin_nit * 14.007/median.C.greens/1000,
         Qmin_mg_P_mg_C = qmin_p * 30.974/median.C.greens/1000,
         Vmax_mg_N_mg_C = vmax_nit* 14.007/median.C.greens/1000,
         Vmax_mg_P_mg_C = vmax_p * 30.974/median.C.greens/1000,
         umax_N = mu_nit,
         umax_P = mu_p)

# save for later
greens.traits.mass.units2 <- greens.traits.mass.units

# summary
(greens.traits.mass <- greens.traits.mass.units %>%
  select(K_P_mgL, K_N_mgL, Qmax_mg_N_mg_C, Qmax_mg_P_mg_C, Qmin_mg_N_mg_C, Qmin_mg_P_mg_C, Vmax_mg_N_mg_C, Vmax_mg_P_mg_C, umax_N, umax_P) %>%
  gather("Trait", "trait.value") %>%
  drop_na() %>%
  group_by(Trait) %>%
  summarise(
    Mean = mean(trait.value, na.rm = T),
    Median = median(trait.value, na.rm = T),
    Min = min(trait.value, na.rm = T), 
    Max = max(trait.value, na.rm = T),
    sd = sd(trait.value, na.rm = T),
    std.err = sd(trait.value, na.rm = T)/sqrt(n()),
    q25 = quantile(trait.value, 0.25, na.rm = T),
    q75 = quantile(trait.value, 0.75, na.rm = T),
    n = n()
  ) %>% mutate(taxon = "greens")) %>%
  knitr::kable()

```

### Cyanobacteria

```{r cyanobacteria traits}

cyanos <- selected.traits[selected.traits$taxon == "cyano" & selected.traits$system == "freshwater",]
#summary(cyanos)
(cyanos.traits <- cyanos %>%
  select(-species, -taxon, -system) %>%
  gather("Trait", "trait.value") %>%
  drop_na() %>%
  group_by(Trait) %>%
  summarise(
    Mean = mean(trait.value, na.rm = T),
    Median = median(trait.value, na.rm = T),
    Min = min(trait.value, na.rm = T), 
    Max = max(trait.value, na.rm = T),
    sd = sd(trait.value, na.rm = T),
    std.err = sd(trait.value, na.rm = T)/sqrt(n()),
    q25 = quantile(trait.value, 0.25, na.rm = T),
    q75 = quantile(trait.value, 0.75, na.rm = T),
    n = n()
  )) %>%
  knitr::kable()

```

#### Cyanobacteria unit conversions

```{r cyanobacteria unit conversions}

# DIY conversions
cyanos.traits.mass.units <- cyanos %>%
   mutate(cell_C_mg = c_per_cell * 12.011/1000,
          K_P_mgL = k_p * 30.974/1000,
          K_N_mgL = k_nit*14.007/1000)
# for Vmax, Qmax use the median C content for conversion
### for diatoms, this will be median of marine C content!
median.C.cyanos <- median(cyanos.traits.mass.units$cell_C_mg, na.rm = T)
median.C.cyanos
# conversions pt 2
cyanos.traits.mass.units <- cyanos.traits.mass.units %>%
  mutate(Qmax_mg_N_mg_C = qmax_nit * 14.007/median.C.greens/1000,
         Qmax_mg_P_mg_C = qmax_p * 30.974/median.C.greens/1000,
         Qmin_mg_N_mg_C = qmin_nit * 14.007/median.C.greens/1000,
         Qmin_mg_P_mg_C = qmin_p * 30.974/median.C.greens/1000,
         Vmax_mg_N_mg_C = vmax_nit* 14.007/median.C.greens/1000,
         Vmax_mg_P_mg_C = vmax_p * 30.974/median.C.greens/1000,
         umax_N = mu_nit,
         umax_P = mu_p)

# save for later
cyanos.traits.mass.units2 <- cyanos.traits.mass.units

# summary
(cyanos.traits.mass <- cyanos.traits.mass.units %>%
  select(K_P_mgL, K_N_mgL, Qmax_mg_N_mg_C, Qmax_mg_P_mg_C, Qmin_mg_N_mg_C, Qmin_mg_P_mg_C, Vmax_mg_N_mg_C, Vmax_mg_P_mg_C, umax_N, umax_P) %>%
  gather("Trait", "trait.value") %>%
  drop_na() %>%
  group_by(Trait) %>%
  summarise(
    Mean = mean(trait.value, na.rm = T),
    Median = median(trait.value, na.rm = T),
    Min = min(trait.value, na.rm = T), 
    Max = max(trait.value, na.rm = T),
    sd = sd(trait.value, na.rm = T),
    std.err = sd(trait.value, na.rm = T)/sqrt(n()),
    q25 = quantile(trait.value, 0.25, na.rm = T),
    q75 = quantile(trait.value, 0.75, na.rm = T),
    n = n()
  ) %>% mutate(taxon = "cyanos")) %>%
  knitr::kable()
```

## Synthesis of data for modelling

Merge data sets

```{r traits merged}

traits.mass <- do.call(rbind, list(diatoms.traits.mass, greens.traits.mass, cyanos.traits.mass))
head(traits.mass)

```

#### Addition of max growth rates and light half saturation constants from Schwaderer et al 2011

```{r summarize and add growth and light data}

(growth.light.summary <- light.umax %>%
  select(Taxon, K_light = Iopt, umax) %>%
  filter(Taxon %in% c("diatoms", "greens", "cyano")) %>%
  gather("Trait", "trait.value", -Taxon) %>%
  drop_na() %>%
  group_by(Taxon, Trait) %>%
  summarise(
    Mean = mean(trait.value, na.rm = T),
    Median = median(trait.value, na.rm = T),
    Min = min(trait.value, na.rm = T), 
    Max = max(trait.value, na.rm = T),
    sd = sd(trait.value, na.rm = T),
    std.err = sd(trait.value, na.rm = T)/sqrt(n()),
    q25 = quantile(trait.value, 0.25, na.rm = T),
    q75 = quantile(trait.value, 0.75, na.rm = T),
    n = n()
  ) %>% mutate(Taxon = ifelse(Taxon == "cyano", "cyanos", Taxon)) %>%
    rename(taxon = Taxon)) %>%
  knitr::kable()


```

```{r merge light and growth data with all other traits}

traits.mass <- rbind(traits.mass, growth.light.summary)

```

#### Overview figure of phytoplankton traits

Plot traits

```{r comparison of median phytoplankton traits, warning=F, message=F, fig.width=15, fig.height=10, dpi = 400}

(traits.fig <- traits.mass %>%
  ggplot(aes(taxon, Median)) + 
  geom_point() + 
  # geom_errorbar(aes(ymin = Median - 1.96 * std.err, 
  #                   ymax = Median + 1.96 * std.err)) + 
  geom_errorbar(aes(ymin = q25, 
                    ymax = q75)) + 
  facet_wrap(Trait~.,scales = "free"))


#save_plot("figures/summary_fig_traits.jpg", traits.fig, base_height = 8, base_width = 12)

```

#### Values for models (Carly + Daniel)

Will use median trait values to parameterize models. Can extract additional values for sensitivity analysis, exploring model space, etc.\
Note that I rounded these values to **3 digits**. Should we use the exact number?

```{r model values}

model.values <- traits.mass %>% 
  select(taxon, Trait, Median) %>%
  pivot_wider(id_cols = Trait, names_from = taxon, values_from = Median) %>%
  mutate_at(2:4, round, 3)
model.values$average <- rowMeans(model.values[,2:3])
model.values %>%  knitr::kable()

#write.csv(model.values, "data4input/phyto_traits4models_21June2024.csv")

# doing the same with 25 and 75 percentiles
model.values.q25 <- traits.mass %>% 
  select(taxon, Trait, q25) %>%
  pivot_wider(id_cols = Trait, names_from = taxon, values_from = q25) %>%
  mutate_at(2:4, round, 3)
model.values$average <- rowMeans(model.values[,2:3])
#write.csv(model.values.q25, "data4input/phyto_traits4models_21June2024_25thquantile.csv")


model.values.q75 <- traits.mass %>% 
  select(taxon, Trait, q75) %>%
  pivot_wider(id_cols = Trait, names_from = taxon, values_from = q75) %>%
  mutate_at(2:4, round, 3)
#model.values$average <- rowMeans(model.values[,2:3])
write.csv(model.values.q75, "data4input/phyto_traits4models_21June2024_75thquantile.csv")

```

## Plot summary ranges for phytoplankton traits

prepare data

```{r}
# bind together
freshwater.traits <- bind_rows(diatoms.traits.mass.units2, greens.traits.mass.units2, cyanos.traits.mass.units2)
# add max growth rate
umaxes <- light.umax %>%
  select(umax, Taxon, Species) %>%
  mutate(taxon = ifelse(Taxon == "greens", "green", 
                         ifelse(Taxon == "diatoms", "diatom", Taxon)),
         species = Species) %>%
  filter(taxon %in% c("diatom", "green", "cyano")) %>%
  select(species, taxon, umax)
# bind with original df
freshwater.traits <- bind_rows(freshwater.traits, umaxes)
# select traits of interest
freshwater.traits <- freshwater.traits %>%
  select(taxon, species, system, c_per_cell, K_P_mgL, K_N_mgL, 
         Qmin_mg_P_mg_C, Qmin_mg_N_mg_C, 
         Vmax_mg_N_mg_C, Vmax_mg_P_mg_C, umax)

```

plot overview of freshwater traits
```{r}
# wide to long
freshwater.traits.long <- freshwater.traits %>%
  gather("Trait", "Trait.Value", -species, -taxon, -system)
# get summary for n()
freshwater.traits.summary <- freshwater.traits.long %>%
  select(-system) %>%
  group_by(taxon, Trait) %>%
  drop_na() %>%
  summarise(n = n(),
            Median.Trait.Value = median(Trait.Value, na.rm =T))

# merge n() back into original df
freshwater.traits.long <- merge(freshwater.traits.long, freshwater.traits.summary, by = c("taxon", "Trait"))

# plot
freshwater.traits.long %>%
  ggplot() + geom_violin(aes(taxon, log10(Trait.Value))) + 
  geom_point(aes(taxon, log10(Median.Trait.Value))) + facet_wrap(Trait~.,scales = "free_y")

# save file
#write.csv(freshwater.traits.long, "data4input/overview_freshwater_traits.csv")

```


## Final notes

-   Diatoms have very high V~max~ for N and P compared to chlorophytes and cyanobacteria.

-   Diatoms mass units calculated using median C cell^-1^ content for **marine** diatoms as there was no data for freshwater.

-   Took K~Light~ and growth rates (u~max~) from Schwaderer et al 2011 as not easily available in Edwards et al. 2011. Maybe we can digitize or otherwise extract these data at some point..
